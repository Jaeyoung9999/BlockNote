"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[496],{4492:function(e,t,i){/**
 * @license React
 * use-sync-external-store-shim.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var r=i(2265),o="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=r.useState,n=r.useEffect,a=r.useLayoutEffect,d=r.useDebugValue;function u(e){var t=e.getSnapshot;e=e.value;try{var i=t();return!o(e,i)}catch(e){return!0}}var c="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var i=t(),r=s({inst:{value:i,getSnapshot:t}}),o=r[0].inst,c=r[1];return a(function(){o.value=i,o.getSnapshot=t,u(o)&&c({inst:o})},[e,i,t]),n(function(){return u(o)&&c({inst:o}),e(function(){u(o)&&c({inst:o})})},[e]),d(i),i};t.useSyncExternalStore=void 0!==r.useSyncExternalStore?r.useSyncExternalStore:c},5107:function(e,t,i){/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var r=i(2265),o=i(554),s="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},n=o.useSyncExternalStore,a=r.useRef,d=r.useEffect,u=r.useMemo,c=r.useDebugValue;t.useSyncExternalStoreWithSelector=function(e,t,i,r,o){var h=a(null);if(null===h.current){var l={hasValue:!1,value:null};h.current=l}else l=h.current;var f=n(e,(h=u(function(){function e(e){if(!d){if(d=!0,n=e,e=r(e),void 0!==o&&l.hasValue){var t=l.value;if(o(t,e))return a=t}return a=e}if(t=a,s(n,e))return t;var i=r(e);return void 0!==o&&o(t,i)?t:(n=e,a=i)}var n,a,d=!1,u=void 0===i?null:i;return[function(){return e(t())},null===u?void 0:function(){return e(u())}]},[t,i,r,o]))[0],h[1]);return d(function(){l.hasValue=!0,l.value=f},[f]),c(f),f}},554:function(e,t,i){e.exports=i(4492)},5006:function(e,t,i){e.exports=i(5107)},3496:function(e,t,i){i.d(t,{$P:function(){return G},EH:function(){return n},WT:function(){return L},Wo:function(){return Z},_A:function(){return z},kB:function(){return Y}});var r=i(2265),o=i(8581);i(554);var s=i(5006);function n(e){let[t,i]=r.useState(!1);return r.useEffect(()=>{i(!0)},[]),r.createElement(r.Suspense,{fallback:e.fallback},t?"function"==typeof e.children?e.children():e.children:e.fallback)}var a=r.createContext(null);function d(e){let t=new Set;t.add("constructor");let i=e.constructor.prototype;do for(let r of Reflect.ownKeys(i)){if(t.has(r))continue;let o=Reflect.getOwnPropertyDescriptor(i,r);"function"==typeof o?.value&&(t.add(r),e[r]=e[r].bind(e))}while((i=Reflect.getPrototypeOf(i))&&i!==Object.prototype)}function u(e,t){return e.createdAt.getTime()-t.createdAt.getTime()}function c(e,t){return(t.updatedAt??t.createdAt).getTime()-(e.updatedAt??e.createdAt).getTime()}function h(e){return"string"==typeof e}var l=Object.freeze({isLoading:!1,data:void 0});function f(e,t){return`${e}-${(0,o.Pz)(t??{})}`}function m(e){return`USER_THREADS:${(0,o.Pz)(e??{})}`}function p(e){return`${e}:NOTIFICATION_SETTINGS`}function b(e){return`${e}-VERSIONS`}function v(e,t){let i=e.threads;null!==t.roomId&&(i=i.filter(e=>e.roomId===t.roomId));let r=t.query;return r&&(i=i.filter(e=>(void 0===r.resolved||e.resolved===r.resolved)&&function(e,t){let i=e.metadata;return void 0===t.metadata||Object.entries(t.metadata).every(([e,t])=>{var r,s;return void 0===t||(r=i[e],s=t,(0,o.PO)(s)&&h(s.startsWith)?h(r)&&r.startsWith(s.startsWith):r===s)})}(e,r))),i.sort("last-update"===t.orderBy?c:u)}var g=Promise.resolve(),y=Object.freeze({isLoading:!0}),A=class{constructor(e){this._cachedPromise=null,this._paginationState=null,this._fetchPage=e,this._eventSource=(0,o.Zb)(),this._pendingFetchMore=null,this.observable=this._eventSource.observable,d(this)}patchPaginationState(e){let t=this._paginationState;null!==t&&(this._paginationState={...t,...e},this._eventSource.notify())}async _fetchMore(){let e=this._paginationState;if(e?.cursor){this.patchPaginationState({isFetchingMore:!0});try{let t=await this._fetchPage(e.cursor);this.patchPaginationState({cursor:t,fetchMoreError:void 0,isFetchingMore:!1})}catch(e){this.patchPaginationState({isFetchingMore:!1,fetchMoreError:e})}}}fetchMore(){let e=this._paginationState;return e?.cursor===null?g:(this._pendingFetchMore||(this._pendingFetchMore=this._fetchMore().finally(()=>{this._pendingFetchMore=null})),this._pendingFetchMore)}get(){let e=this._cachedPromise;if(null===e||"pending"===e.status)return y;if("rejected"===e.status)return{isLoading:!1,error:e.reason};let t=this._paginationState;return{isLoading:!1,data:{fetchMore:this.fetchMore,isFetchingMore:t.isFetchingMore,fetchMoreError:t.fetchMoreError,hasFetchedAll:null===t.cursor}}}waitUntilLoaded(){var e;if(this._cachedPromise)return this._cachedPromise;let t=("status"in(e=(0,o.du)(()=>this._fetchPage(void 0),5,[5e3,5e3,1e4,15e3]).then(e=>{this._paginationState={cursor:e,isFetchingMore:!1,fetchMoreError:void 0}}))||(e.status="pending",e.then(t=>{e.status="fulfilled",e.value=t},t=>{e.status="rejected",e.reason=t})),e);return t.then(()=>this._eventSource.notify(),()=>{this._eventSource.notify(),setTimeout(()=>{this._cachedPromise=null,this._eventSource.notify()},5e3)}),this._cachedPromise=t,t}},I=class{constructor(e){this._prevState=null,this._stateCached=null,this._notificationsLastRequestedAt=null,this._roomThreadsLastRequestedAtByRoom=new Map,this._roomThreads=new Map,this._userThreadsLastRequestedAt=null,this._userThreads=new Map;let t=async t=>{if(void 0===e)throw new o.MC("Client is required in order to load threads for the room");let i=await e.getInboxNotifications({cursor:t});return this.updateThreadsAndNotifications(i.threads,i.inboxNotifications),null===this._notificationsLastRequestedAt&&(this._notificationsLastRequestedAt=i.requestedAt),i.nextCursor};this._client=e,this._notifications=new A(t),this._notifications.observable.subscribe(()=>this._store.set(e=>({...e}))),this._store=(0,o.MT)({rawThreadsById:{},queries3:{},queries4:{},optimisticUpdates:[],notificationsById:{},settingsByRoomId:{},versionsByRoomId:{}}),d(this)}get(){let e=this._store.get();return(this._prevState!==e||null===this._stateCached)&&(this._prevState=e,this._stateCached=function(e){let t={threadsById:{...e.rawThreadsById},notificationsById:{...e.notificationsById},settingsByRoomId:{...e.settingsByRoomId}};for(let i of e.optimisticUpdates)switch(i.type){case"create-thread":t.threadsById[i.thread.id]=i.thread;break;case"edit-thread-metadata":{let e=t.threadsById[i.threadId];if(void 0===e||void 0!==e.deletedAt||void 0!==e.updatedAt&&e.updatedAt>i.updatedAt)break;t.threadsById[e.id]={...e,updatedAt:i.updatedAt,metadata:{...e.metadata,...i.metadata}};break}case"mark-thread-as-resolved":{let e=t.threadsById[i.threadId];if(void 0===e||void 0!==e.deletedAt)break;t.threadsById[e.id]={...e,resolved:!0};break}case"mark-thread-as-unresolved":{let e=t.threadsById[i.threadId];if(void 0===e||void 0!==e.deletedAt)break;t.threadsById[e.id]={...e,resolved:!1};break}case"create-comment":{let e=t.threadsById[i.comment.threadId];if(void 0===e)break;t.threadsById[e.id]=_(e,i.comment);let r=Object.values(t.notificationsById).find(t=>"thread"===t.kind&&t.threadId===e.id);if(void 0===r)break;t.notificationsById[r.id]={...r,notifiedAt:i.comment.createdAt,readAt:i.comment.createdAt};break}case"edit-comment":{let e=t.threadsById[i.comment.threadId];if(void 0===e)break;t.threadsById[e.id]=_(e,i.comment);break}case"delete-comment":{let e=t.threadsById[i.threadId];if(void 0===e)break;t.threadsById[e.id]=T(e,i.commentId,i.deletedAt);break}case"delete-thread":{let e=t.threadsById[i.threadId];if(void 0===e)break;t.threadsById[i.threadId]={...e,deletedAt:i.deletedAt,updatedAt:i.deletedAt,comments:[]};break}case"add-reaction":{let e=t.threadsById[i.threadId];if(void 0===e)break;t.threadsById[e.id]=w(e,i.commentId,i.reaction);break}case"remove-reaction":{let e=t.threadsById[i.threadId];if(void 0===e)break;t.threadsById[e.id]=S(e,i.commentId,i.emoji,i.userId,i.removedAt);break}case"mark-inbox-notification-as-read":{let e=t.notificationsById[i.inboxNotificationId];if(void 0===e)break;t.notificationsById[i.inboxNotificationId]={...e,readAt:i.readAt};break}case"mark-all-inbox-notifications-as-read":for(let e in t.notificationsById){let r=t.notificationsById[e];if(void 0===r)break;t.notificationsById[e]={...r,readAt:i.readAt}}break;case"delete-inbox-notification":delete t.notificationsById[i.inboxNotificationId];break;case"delete-all-inbox-notifications":t.notificationsById={};break;case"update-notification-settings":{let e=t.settingsByRoomId[i.roomId];if(void 0===e)break;t.settingsByRoomId[i.roomId]={...e,...i.settings}}}let i=Object.values(t.threadsById).filter(e=>!e.deletedAt).filter(e=>e.comments.some(e=>void 0===e.deletedAt));return{notifications:Object.values(t.notificationsById).filter(e=>"thread"!==e.kind||t.threadsById[e.threadId]&&t.threadsById[e.threadId]?.deletedAt===void 0).sort((e,t)=>t.notifiedAt.getTime()-e.notifiedAt.getTime()),notificationsById:t.notificationsById,settingsByRoomId:t.settingsByRoomId,queries3:e.queries3,queries4:e.queries4,threads:i,threadsById:t.threadsById,versionsByRoomId:e.versionsByRoomId}}(e)),this._stateCached}batch(e){return this._store.batch(e)}getFullState(){return this.get()}getRoomThreadsAsync(e,t){let i=f(e,t),r=this._roomThreads.get(i);if(void 0===r)return y;let o=r.get();if(o.isLoading||o.error)return o;let s=v(this.getFullState(),{roomId:e,query:t,orderBy:"age"}),n=o.data;return{isLoading:!1,threads:s,hasFetchedAll:n.hasFetchedAll,isFetchingMore:n.isFetchingMore,fetchMoreError:n.fetchMoreError,fetchMore:n.fetchMore}}getUserThreadsAsync(e){let t=m(e),i=this._userThreads.get(t);if(void 0===i)return y;let r=i.get();if(r.isLoading||r.error)return r;let o=v(this.getFullState(),{roomId:null,query:e,orderBy:"last-update"}),s=r.data;return{isLoading:!1,threads:o,hasFetchedAll:s.hasFetchedAll,isFetchingMore:s.isFetchingMore,fetchMoreError:s.fetchMoreError,fetchMore:s.fetchMore}}getInboxNotificationsAsync(){let e=this._notifications.get();if(e.isLoading||e.error)return e;let t=e.data;return{isLoading:!1,inboxNotifications:this.getFullState().notifications,hasFetchedAll:t.hasFetchedAll,isFetchingMore:t.isFetchingMore,fetchMoreError:t.fetchMoreError,fetchMore:t.fetchMore}}getNotificationSettingsAsync(e){let t=this.get(),i=t.queries3[p(e)];return void 0===i||i.isLoading?y:void 0!==i.error?i:{isLoading:!1,settings:(0,o.nn)(t.settingsByRoomId[e])}}getVersionsAsync(e){let t=this.get(),i=t.queries4[b(e)];return void 0===i||i.isLoading?y:void 0!==i.error?i:{isLoading:!1,versions:(0,o.nn)(t.versionsByRoomId[e])}}_hasOptimisticUpdates(){return this._store.get().optimisticUpdates.length>0}subscribe(e){return this._store.subscribe(e)}_subscribeOptimisticUpdates(e){return this.subscribe(e)}subscribeThreads(e){return this.subscribe(e)}subscribeUserThreads(e){return this.subscribe(e)}subscribeThreadsOrInboxNotifications(e){return this.subscribe(e)}subscribeNotificationSettings(e){return this.subscribe(e)}subscribeVersions(e){return this.subscribe(e)}updateThreadsCache(e){this._store.set(t=>{let i=e(t.rawThreadsById);return i!==t.rawThreadsById?{...t,rawThreadsById:i}:t})}updateInboxNotificationsCache(e){this._store.set(t=>{let i=e(t.notificationsById);return i!==t.notificationsById?{...t,notificationsById:i}:t})}setNotificationSettings(e,t){this._store.set(i=>({...i,settingsByRoomId:{...i.settingsByRoomId,[e]:t}}))}setVersions(e,t){this._store.set(i=>({...i,versionsByRoomId:{...i.versionsByRoomId,[e]:t}}))}setQuery3State(e,t){this._store.set(i=>({...i,queries3:{...i.queries3,[e]:t}}))}setQuery4State(e,t){this._store.set(i=>({...i,queries4:{...i.queries4,[e]:t}}))}updateOptimisticUpdatesCache(e){this._store.set(t=>({...t,optimisticUpdates:e(t.optimisticUpdates)}))}force_set(e){return this._store.set(e)}updateInboxNotification(e,t,i){this._store.batch(()=>{this.removeOptimisticUpdate(t),this.updateInboxNotificationsCache(t=>{let r=t[e];return r?{...t,[e]:i(r)}:t})})}updateAllInboxNotifications(e,t){this._store.batch(()=>{this.removeOptimisticUpdate(e),this.updateInboxNotificationsCache(e=>(0,o.Q8)(e,t))})}deleteInboxNotification(e,t){this._store.batch(()=>{this.removeOptimisticUpdate(t),this.updateInboxNotificationsCache(t=>{let{[e]:i,...r}=t;return void 0===i?t:r})})}deleteAllInboxNotifications(e){this._store.batch(()=>{this.removeOptimisticUpdate(e),this.updateInboxNotificationsCache(()=>({}))})}createThread(e,t){this._store.batch(()=>{this.removeOptimisticUpdate(e),this.updateThreadsCache(e=>({...e,[t.id]:t}))})}updateThread(e,t,i,r){this._store.batch(()=>{null!==t&&this.removeOptimisticUpdate(t),this.updateThreadsCache(t=>{let o=t[e];return!o||void 0!==o.deletedAt||r&&o.updatedAt&&o.updatedAt>r?t:{...t,[e]:i(o)}})})}patchThread(e,t,i,r){return this.updateThread(e,t,e=>({...e,...(0,o.yg)(i)}),r)}addReaction(e,t,i,r,o){this.updateThread(e,t,e=>w(e,i,r),o)}removeReaction(e,t,i,r,o,s){this.updateThread(e,t,e=>S(e,i,r,o,s),s)}deleteThread(e,t){return this.updateThread(e,t,e=>({...e,updatedAt:new Date,deletedAt:new Date}))}createComment(e,t){this._store.batch(()=>{this.removeOptimisticUpdate(t);let i=this._store.get().rawThreadsById[e.threadId];i&&(this.updateThreadsCache(t=>({...t,[e.threadId]:_(i,e)})),this.updateInboxNotificationsCache(t=>{let i=Object.values(t).find(t=>"thread"===t.kind&&t.threadId===e.threadId);return i?{...t,[i.id]:{...i,notifiedAt:e.createdAt,readAt:e.createdAt}}:t}))})}editComment(e,t,i){return this.updateThread(e,t,e=>_(e,i))}deleteComment(e,t,i,r){return this.updateThread(e,t,e=>T(e,i,r),r)}updateThreadAndNotification(e,t){this._store.batch(()=>{this.updateThreadsCache(t=>{let i=t[e.id];return void 0===i||0>c(e,i)?{...t,[e.id]:e}:t}),void 0!==t&&this.updateInboxNotificationsCache(e=>({...e,[t.id]:t}))})}updateThreadsAndNotifications(e,t,i=[],r=[]){this._store.batch(()=>{this.updateThreadsCache(t=>(function(e,t){let i={...e};return t.newThreads.forEach(e=>{let t=i[e.id];!(t&&0>c(t,e))&&(i[e.id]=e)}),t.deletedThreads.forEach(({id:e,deletedAt:t})=>{let r=i[e];void 0!==r&&(r.deletedAt=t,r.updatedAt=t,r.comments=[])}),i})(t,{newThreads:e,deletedThreads:i})),this.updateInboxNotificationsCache(e=>(function(e,t){let i={...e};return t.newInboxNotifications.forEach(e=>{let t=i[e.id];(!t||1!=(t.notifiedAt>e.notifiedAt?1:t.notifiedAt<e.notifiedAt?-1:t.readAt&&e.readAt?t.readAt>e.readAt?1:t.readAt<e.readAt?-1:0:t.readAt||e.readAt?t.readAt?1:-1:0))&&(i[e.id]=e)}),t.deletedNotifications.forEach(({id:e})=>delete i[e]),i})(e,{newInboxNotifications:t,deletedNotifications:r}))})}updateRoomInboxNotificationSettings2(e,t,i){this._store.batch(()=>{this.removeOptimisticUpdate(t),this.setNotificationSettings(e,i)})}updateRoomInboxNotificationSettings(e,t,i){this._store.batch(()=>{this.setQuery3OK(i),this.setNotificationSettings(e,t)})}updateRoomVersions(e,t,i){this._store.batch(()=>{this.setVersions(e,t),void 0!==i&&this.setQuery4OK(i)})}addOptimisticUpdate(e){let t=(0,o.x0)(),i={...e,id:t};return this.updateOptimisticUpdatesCache(e=>[...e,i]),t}removeOptimisticUpdate(e){this.updateOptimisticUpdatesCache(t=>t.filter(t=>t.id!==e))}setQuery3Loading(e){this.setQuery3State(e,y)}setQuery3OK(e){this.setQuery3State(e,l)}setQuery3Error(e,t){this.setQuery3State(e,{isLoading:!1,error:t})}setQuery4Loading(e){this.setQuery4State(e,y)}setQuery4OK(e){this.setQuery4State(e,l)}setQuery4Error(e,t){this.setQuery4State(e,{isLoading:!1,error:t})}async fetchNotificationsDeltaUpdate(){let e=this._notificationsLastRequestedAt;if(null===e){o.iV.warn("Notifications polled before first page loaded");return}let t=(0,o.nn)(this._client,"Client is required in order to load notifications for the room"),i=await t.getInboxNotificationsSince(e);e<i.requestedAt&&(this._notificationsLastRequestedAt=i.requestedAt),this.updateThreadsAndNotifications(i.threads.updated,i.inboxNotifications.updated,i.threads.deleted,i.inboxNotifications.deleted)}waitUntilNotificationsLoaded(){return this._notifications.waitUntilLoaded()}waitUntilRoomThreadsLoaded(e,t){let i=async i=>{if(void 0===this._client)throw new o.MC("Client is required in order to load threads for the room");let r=this._client.getRoom(e);if(null===r)throw new o.MC(`Room with id ${e} is not available on client`);let s=await r.getThreads({cursor:i,query:t});this.updateThreadsAndNotifications(s.threads,s.inboxNotifications);let n=this._roomThreadsLastRequestedAtByRoom.get(e);return(void 0===n||n>s.requestedAt)&&this._roomThreadsLastRequestedAtByRoom.set(e,s.requestedAt),s.nextCursor},r=f(e,t),s=this._roomThreads.get(r);return void 0===s&&(s=new A(i)),s.observable.subscribe(()=>this._store.set(e=>({...e}))),this._roomThreads.set(r,s),s.waitUntilLoaded()}async fetchRoomThreadsDeltaUpdate(e){let t=this._roomThreadsLastRequestedAtByRoom.get(e);if(void 0===t){o.iV.warn("Room threads polled before first page loaded");return}let i=(0,o.nn)(this._client,"Client is required in order to load notifications for the room"),r=(0,o.nn)(i.getRoom(e),`Room with id ${e} is not available on client`),s=await r.getThreadsSince({since:t});this.updateThreadsAndNotifications(s.threads.updated,s.inboxNotifications.updated,s.threads.deleted,s.inboxNotifications.deleted),t<s.requestedAt&&this._roomThreadsLastRequestedAtByRoom.set(e,s.requestedAt)}waitUntilUserThreadsLoaded(e){let t=m(e),i=async t=>{if(void 0===this._client)throw new o.MC("Client is required in order to load threads for the room");let i=await this._client[o.W_].getUserThreads_experimental({cursor:t,query:e});return this.updateThreadsAndNotifications(i.threads,i.inboxNotifications),null===this._userThreadsLastRequestedAt&&(this._userThreadsLastRequestedAt=i.requestedAt),i.nextCursor},r=this._userThreads.get(t);return void 0===r&&(r=new A(i)),r.observable.subscribe(()=>this._store.set(e=>({...e}))),this._userThreads.set(t,r),r.waitUntilLoaded()}async fetchUserThreadsDeltaUpdate(){let e=this._userThreadsLastRequestedAt;if(null===e){o.iV.warn("User threads polled before first page loaded");return}let t=(0,o.nn)(this._client,"Client is required in order to load threads for the user"),i=await t[o.W_].getUserThreadsSince_experimental({since:e});e<i.requestedAt&&(this._notificationsLastRequestedAt=i.requestedAt),this.updateThreadsAndNotifications(i.threads.updated,i.inboxNotifications.updated,i.threads.deleted,i.inboxNotifications.deleted)}};function _(e,t){if(void 0!==e.deletedAt)return e;if(t.threadId!==e.id)return o.iV.warn(`Comment ${t.id} does not belong to thread ${e.id}`),e;let i=e.comments.find(e=>e.id===t.id);if(void 0===i){let i=new Date(Math.max(e.updatedAt?.getTime()||0,t.createdAt.getTime()));return{...e,updatedAt:i,comments:[...e.comments,t]}}if(void 0!==i.deletedAt)return e;if(void 0===i.editedAt||void 0===t.editedAt||i.editedAt<=t.editedAt){let i=e.comments.map(e=>e.id===t.id?t:e);return{...e,updatedAt:new Date(Math.max(e.updatedAt?.getTime()||0,t.editedAt?.getTime()||t.createdAt.getTime())),comments:i}}return e}function T(e,t,i){if(void 0!==e.deletedAt)return e;let r=e.comments.find(e=>e.id===t);if(void 0===r||void 0!==r.deletedAt)return e;let o=e.comments.map(e=>e.id===t?{...e,deletedAt:i,body:void 0,attachments:[]}:e);return o.every(e=>void 0!==e.deletedAt)?{...e,deletedAt:i,updatedAt:i}:{...e,updatedAt:i,comments:o}}function w(e,t,i){if(void 0!==e.deletedAt)return e;let r=e.comments.find(e=>e.id===t);if(void 0===r||void 0!==r.deletedAt)return e;let o=e.comments.map(e=>e.id===t?{...e,reactions:function(e,t){let i=e.find(e=>e.emoji===t.emoji);return void 0===i?[...e,{emoji:t.emoji,createdAt:t.createdAt,users:[{id:t.userId}]}]:!1===i.users.some(e=>e.id===t.userId)?e.map(e=>e.emoji===t.emoji?{...e,users:[...e.users,{id:t.userId}]}:e):e}(e.reactions,i)}:e);return{...e,updatedAt:new Date(Math.max(i.createdAt.getTime(),e.updatedAt?.getTime()||0)),comments:o}}function S(e,t,i,r,o){if(void 0!==e.deletedAt)return e;let s=e.comments.find(e=>e.id===t);if(void 0===s||void 0!==s.deletedAt)return e;let n=e.comments.map(e=>e.id===t?{...e,reactions:e.reactions.map(e=>e.emoji===i?{...e,users:e.users.filter(e=>e.id!==r)}:e).filter(e=>e.users.length>0)}:e);return{...e,updatedAt:new Date(Math.max(o.getTime(),e.updatedAt?.getTime()||0)),comments:n}}var E=e=>e;function R(e){return(0,r.useReducer)(E,e)[0]}function B(e){let t=R(e);if("function"!=typeof t)return t;{let t=function(e){let t=(0,r.useRef)(e);return(0,r.useEffect)(()=>{t.current=e},[e]),t}(e);return(0,r.useCallback)((...e)=>t.current(...e),[t])}}var M=e=>{if("pending"===e.status)throw e;if("fulfilled"===e.status)return e.value;if("rejected"===e.status)throw e.reason;throw e.status="pending",e.then(t=>{e.status="fulfilled",e.value=t},t=>{e.status="rejected",e.reason=t}),e},N=(0,r.createContext)(null),C=new WeakMap;function x(e){let t=C.get(e);return t||(t=new I(e),C.set(e,t)),t}function k(){return(0,r.useContext)(N)}function O(){return k()??(0,o.OU)("LiveblocksProvider is missing from the React tree.")}function U(e){return!function(e){let t=k();if(!e?.allowNesting&&null!==t)throw Error("You cannot nest multiple LiveblocksProvider instances in the same React tree.")}(e),r.createElement(N.Provider,{value:e.client},e.children)}function L(e){let{children:t,...i}=e,s={publicApiKey:R(i.publicApiKey),throttle:R(i.throttle),lostConnectionTimeout:R(i.lostConnectionTimeout),backgroundKeepAliveTimeout:R(i.backgroundKeepAliveTimeout),polyfills:R(i.polyfills),unstable_fallbackToHTTP:R(i.unstable_fallbackToHTTP),unstable_streamData:R(i.unstable_streamData),authEndpoint:B(i.authEndpoint),resolveMentionSuggestions:B(i.resolveMentionSuggestions),resolveUsers:B(i.resolveUsers),resolveRoomsInfo:B(i.resolveRoomsInfo),baseUrl:R(i.baseUrl),enableDebugLogging:R(i.enableDebugLogging)},n=(0,r.useMemo)(()=>(0,o.eI)(s),[]);return r.createElement(U,{client:n},t)}function q(e,t){t>=5||setTimeout(()=>{e()},5e3*Math.pow(2,t))}var D=e=>e,F=Object.freeze([]);function P(){return F}function j(){return null}function Q(e){let t=`Request failed with status ${e.status}: ${e.message}`;if(e.details?.error==="FORBIDDEN"){let i=[t,e.details.suggestion,e.details.docs].filter(Boolean).join("\n");o.iV.error(i)}return Error(t)}var V=new WeakMap;function W(e){let t=V.get(e);return t||(t=function(e){let t=x(e),i=new Map;async function r(e,{retryCount:s}={retryCount:0}){let n=b(e.id),a=i.get(n);if(void 0!==a)return a;let d=e[o.W_].listTextVersions();i.set(n,d),t.setQuery4Loading(n);try{let r=await d,o=(await r.json()).versions.map(({createdAt:e,...t})=>({createdAt:new Date(e),...t}));t.updateRoomVersions(e.id,o,n),i.delete(n)}catch(o){i.delete(n),q(()=>{r(e,{retryCount:s+1})},s),t.setQuery4Error(n,o)}}async function s(e,{retryCount:r}={retryCount:0}){let o=p(e.id),n=i.get(o);if(void 0!==n)return n;try{let r=e.getNotificationSettings();i.set(o,r),t.setQuery3Loading(o);let s=await r;t.updateRoomInboxNotificationSettings(e.id,s,o)}catch(n){i.delete(o),q(()=>{s(e,{retryCount:r+1})},r),t.setQuery3Error(o,n)}}let n=(0,o.Zb)();return{store:t,subscribeToRoomThreadsDeltaUpdates:function(e){let t=x(e),i=(0,o.x3)(async()=>{let i=e[o.W_].getRoomIds();await Promise.allSettled(i.map(i=>{let r=e.getRoom(i);if(null!==r)return t.fetchRoomThreadsDeltaUpdate(r.id)}))},3e5),r=0;return()=>(r++,i.enable(r>0),()=>{r--,i.enable(r>0)})}(e),commentsErrorEventSource:n,getInboxNotificationSettings:s,getRoomVersions:r,onMutationFailure:function(e,i,r){if(t.removeOptimisticUpdate(i),e instanceof o.iz){let t=Q(e);n.notify(r(t));return}if(e instanceof o.VB){Q(e);return}throw e}}}(e),V.set(e,t)),t}function $(e){let t=O(),{id:i,stableEnterRoom:s}=e,n=R({initialPresence:e.initialPresence,initialStorage:e.initialStorage,unstable_batchedUpdates:e.unstable_batchedUpdates,autoConnect:e.autoConnect??"undefined"!=typeof window}),[{room:d},u]=r.useState(()=>s(i,{...n,autoConnect:!1}));return r.useEffect(()=>{let{store:e}=W(t);async function i(t){if(t.type===o.yO.THREAD_DELETED){e.deleteThread(t.threadId,null);return}let i=await d.getThread(t.threadId);if(!i.thread){e.deleteThread(t.threadId,null);return}let{thread:r,inboxNotification:s}=i,n=e.getFullState().threadsById[t.threadId];switch(t.type){case o.yO.COMMENT_EDITED:case o.yO.THREAD_METADATA_UPDATED:case o.yO.THREAD_UPDATED:case o.yO.COMMENT_REACTION_ADDED:case o.yO.COMMENT_REACTION_REMOVED:case o.yO.COMMENT_DELETED:if(!n)break;e.updateThreadAndNotification(r,s);break;case o.yO.COMMENT_CREATED:e.updateThreadAndNotification(r,s)}}return d.events.comments.subscribe(e=>void i(e))},[t,d]),r.useEffect(()=>{W(t).store.fetchRoomThreadsDeltaUpdate(d.id).catch(()=>{})},[t,d.id]),r.useEffect(()=>{function e(){W(t).store.fetchRoomThreadsDeltaUpdate(d.id).catch(()=>{})}return window.addEventListener("online",e),()=>{window.removeEventListener("online",e)}},[t,d.id]),r.useEffect(()=>{let e=s(i,n);u(e);let{room:t,leave:r}=e;return n.autoConnect&&t.connect(),()=>{r()}},[i,n,s]),r.createElement(a.Provider,{value:d},e.children)}function K(){let e=r.useContext(a);if(null===e)throw Error("RoomProvider is missing from the React tree.");return e}function H(){!function(){if("undefined"==typeof window)throw Error("You cannot use the Suspense version of this hook on the server side. Make sure to only call them on the client side.\nFor tips, see https://liveblocks.io/docs/api-reference/liveblocks-react#suspense-avoid-ssr")}(),M(K().waitUntilPresenceReady())}Symbol();var z=function(e){let t=O(),[i]=r.useState(()=>new Map),o=r.useCallback((e,r)=>{let o=i.get(e);if(o)return o;let s=t.enterRoom(e,r),n=s.leave;return s.leave=()=>{n(),i.delete(e)},i.set(e,s),s},[t,i]);return r.createElement($,{...e,stableEnterRoom:o})},Y=K;function Z(...e){return function(e,t){return H(),function(e,t){let i=K(),r=i.events.others.subscribe,o=i.getOthers;return(0,s.useSyncExternalStoreWithSelector)(r,o,P,e??D,t)}(e,t)}(...e)}function G(...e){return function(e,t){return H(),function(e,t){let i=K(),o=i.events.self.subscribe,n=i.getSelf,a=e??D,d=r.useCallback(e=>null!==e?a(e):null,[a]);return(0,s.useSyncExternalStoreWithSelector)(o,n,j,d,t)}(e,t)}(...e)}}}]);